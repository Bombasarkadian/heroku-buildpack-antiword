#!/bin/bash
BUILD_DIR=$1
DEFAULT_DIR=`pwd`

# antiword based on https://github.com/bricel/heroku-buildpack-antiword
INSTALL_DIR=$BUILD_DIR/vendor/antiword/
ANTIWORD_DIR=${HOME}/vendor/antiword/antiword-0.37

cd $DEFAULT_DIR

echo "Untarring antiword-0.37.tar.gz into ${INSTALL_DIR}"

mkdir -p $INSTALL_DIR
tar -zxvf antiword-0.37.tar.gz -C $INSTALL_DIR
cd ${INSTALL_DIR}antiword-0.37
make

echo "Complete!"

# pdftotext based on https://github.com/tadas-s/heroku-buildpack-pdftotext
INSTALL_DIR=$BUILD_DIR/vendor/pdftotext/
PDFTOTEXT_DIR=$BUILD_DIR

cd $DEFAULT_DIR

echo "Copying pdftotext-${STACK} into ${INSTALL_DIR}"

mkdir -p $INSTALL_DIR
cp "bin/pdftotext-${STACK}" "${INSTALL_DIR}pdftotext"

echo "Complete!"

# unrtf based on https://github.com/andre0799/heroku-buildpack-unrtf and https://github.com/bricel/heroku-buildpack-antiword
VERSION=unrtf-0.21.9
INSTALL_DIR=$BUILD_DIR/vendor/unrtf/
UNRTF_DIR=${HOME}/vendor/unrtf/unrtf-0.21.9

cd $DEFAULT_DIR

echo "Untarring unrtf-0.21.9.tar.gz into ${INSTALL_DIR}"

mkdir -p $INSTALL_DIR
tar -zxvf unrtf-0.21.9.tar.gz -C $INSTALL_DIR
cd ${INSTALL_DIR}unrtf-0.21.9
autoreconf -ivf
./configure
make

echo "Complete!"

# finishing touches
echo "Building runtime environment in ${BUILD_DIR}"

mkdir -p $BUILD_DIR/.profile.d
echo "Making ${BUILD_DIR}/.profile.d"

echo "export PATH=\"${ANTIWORD_DIR}:${PDFTOTEXT_DIR}:${UNRTF_DIR}:\$PATH\"" > $BUILD_DIR/.profile.d/textract.sh
